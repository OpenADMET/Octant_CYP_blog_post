# CLAUDE.md — CYP Data Engine Blog Post

Scientific blog post and interactive data release for the OpenADMET Octant CYP inhibition and reaction phenotyping dataset. Rendered with [Quarto](https://quarto.org/), combining R (ggplot2/ggiraph) and Python (bokeh/rdkit) for interactive visualizations.

**Publication date:** March 2, 2026
**Output:** `_site/index.html` (tracked in git — this is the published artifact)

---

## Environment Setup

Both R and Python environments must be restored before rendering.

**R packages** (renv-managed):
```r
renv::restore()
```

**Python packages** (uv-managed):
```bash
uv sync
```

direnv is configured via `.envrc` (uses `use_uv`). After `uv sync`, activating the environment is automatic with direnv, or manually:
```bash
source .venv/bin/activate
```

**Prerequisites:** Quarto ≥ 1.4, R ≥ 4.5, Python ≥ 3.13, uv, renv

---

## Rendering

**Blog version** (no code shown — default):
```bash
quarto render
```
Output: `_site/index.html`

**Notebook version** (code visible with fold/expand):
```bash
quarto render --profile notebook
```
Output: `_site/notebook/index.html`

**Preview** (serve rendered output locally):
```bash
cd _site && python -m http.server 8000
```

**Single figure** (faster iteration during development):
```bash
quarto render post/figures/figure_1.qmd
```

> **Note:** `cyp-blog-post.qmd` is generated by `scripts/assemble_blog.R` — do not edit it by hand.

---

## Project Structure

```
.
├── cyp-blog-post.qmd          # Main blog post (auto-generated — do not edit)
├── _quarto.yml                # Quarto config (HTML format, CSS, JS)
├── _quarto-notebook.yml       # Notebook render profile
├── pyproject.toml             # Python dependencies (uv)
├── renv.lock                  # R dependency lockfile (renv)
├── uv.lock                    # Python dependency lockfile (uv)
│
├── post/
│   ├── _setup_r.qmd           # R package loading + shared state
│   ├── _setup_python.qmd      # Python imports + utilities (smiles_to_svg, make_swarm_svg, etc.)
│   ├── Figure_5.png           # Static figure (R-generated, committed)
│   └── figures/
│       ├── figure_1.qmd       # CYP reactivity + inhibition overview (R/ggplot2)
│       ├── figure_2.qmd       # Interactive CYP3A4 vs CYP2J2 (R/ggiraph)
│       ├── figure_3.qmd       # Inhibition potency vs reactivity (Python/bokeh)
│       ├── figure_3.py        # Standalone Python script version of figure 3
│       ├── figure_4.qmd       # Figure 4
│       ├── figure_6.qmd       # Figure 6
│       ├── figure_7.qmd       # Figure 7
│       └── assets/
│           └── figure_4C.png  # Static asset for figure 4
│
├── R/
│   └── helpers.R              # Color palettes (cbpalette, cbpalette2) + theme_pub()
│
├── data/
│   ├── reactivity.tsv         # Echo-MS peak areas (19,344 rows)
│   ├── inhibition.tsv         # CYP3A4 pIC50 values + SMILES (1,340 rows)
│   ├── inhibition_wells.tsv   # Well-level fluorescence DRC data (16,931 rows)
│   ├── willitfly.tsv          # Ionization buffer comparison (11,353 rows)
│   ├── clearance_snippet.tsv  # Metabolic clearance example (292 rows)
│   ├── tdi_drc_curves.tsv     # TDI fitted curves (3,012 rows)
│   ├── tdi_drc_params.tsv     # TDI fit parameters (12 rows)
│   ├── tdi_drc_points.tsv     # TDI curve points (144 rows)
│   ├── tdi_pic50_shift.tsv    # pIC50 shift estimates (6 rows)
│   ├── citations.tsv          # Citation metadata
│   └── inhibition_drc-plots/  # 1,343 PNG dose-response curves (156 MB, used as tooltips)
│
├── protocols/
│   ├── cyp_reactivity_assay.md    # CYP3A4/CYP2J2 reactivity screening protocol
│   └── cyp_inhibition_assay.md    # CYP3A4 inhibition assay protocol
│
└── _site/                     # Rendered output (tracked in git — published artifact)
    ├── index.html
    ├── assets/tooltips/       # SVG/PNG tooltip assets written at render time
    └── cyp-blog-post_files/   # Quarto supporting libs (JS/CSS)
```

---

## Key Architecture Notes

### Python utilities (`post/_setup_python.qmd`)
Defines shared utilities injected into all Python figure cells:
- `smiles_to_svg(smiles)` — renders molecule structure via RDKit → SVG string
- `save_tooltip_svg(svg, name)` / `_save_tooltip(bytes, name)` — writes SVG/PNG assets to `_site/assets/tooltips/` and returns a relative URL (avoids inlining large base64 in HTML)
- `make_swarm_svg(batch_id, peak_areas, enzymes)` — generates beeswarm plot SVG for tooltip
- `repo_root` — `pathlib.Path` to the repository root (set via `.here` marker)

### R utilities (`R/helpers.R`)
- `theme_pub()` — ggplot2 publication theme
- `cbpalette` / `cbpalette2` — colorblind-safe palettes

### Interactive figures
- **R figures** use `ggiraph` for hover tooltips and fullscreen modals; custom JS in `_quarto.yml` injects figure captions into fullscreen modal
- **Python figures** use `bokeh` with `HoverTool` showing molecule structure, swarm plot, and DRC curve in the tooltip
- Tooltip assets are written to `_site/assets/tooltips/` at render time (not base64-inlined)

### `_site/` is tracked in git
The rendered output is committed because `_site/assets/tooltips/` (1,343 DRC PNG files) is needed for the deployed site and is too large to regenerate on CI. If you re-render, commit the updated `_site/`.

---

## Development Workflow

1. Edit figure QMD files in `post/figures/`
2. Render individual figures for fast iteration: `quarto render post/figures/figure_N.qmd`
3. Full render: `quarto render`
4. Preview: `cd _site && python -m http.server 8000`
5. Commit `_site/` changes along with source changes

### Gotchas
- `cyp-blog-post.qmd` says "do not edit by hand" — it's assembled from source files by `scripts/assemble_blog.R`
- Figure 3 is Python/bokeh; all others are R/ggplot2 or R/ggiraph
- The `figure_3.py` standalone script duplicates some logic from `figure_3.qmd` — the `.qmd` is the canonical version used for rendering
- `inhibition_drc-plots/` (156 MB of PNGs) is in `data/` and referenced at render time to build tooltip assets
- R uses `here::here()` for paths; Python uses `repo_root` (a `pathlib.Path` set in `_setup_python.qmd`)
- Both `renv.lock` and `uv.lock` must be kept in sync when adding dependencies

---

## Adding/Updating Dependencies

**Python:** Edit `pyproject.toml`, then:
```bash
uv add <package>     # adds and updates uv.lock
uv sync              # installs from lock
```

**R:** In R console:
```r
install.packages("package")
renv::snapshot()     # updates renv.lock
```
