```{r}
#| label: figure-1-setup
#| message: false
#| cache: false

library(tidyverse)
library(ggbeeswarm)
library(patchwork)
library(here)
source(here("R", "helpers.R"))
theme_set(theme_pub(base_size = 12))
```

```{r}
#| label: figure-1
#| fig-width: 10
#| fig-height: 7
#| message: false
#| cache: true

# --- data loading ---
reactivity_raw <- read_tsv(here("data", "reactivity.tsv"))
inhibition_df <- read_tsv(here("data", "inhibition.tsv"))

# --- summarize reactivity replicates ---
react_summary <- reactivity_raw |>
  group_by(ocnt_batch, enzyme, condition) |>
  summarise(mean_area = mean(area), .groups = "drop") |>
  pivot_wider(names_from = condition, values_from = mean_area) |>
  mutate(
    log10_control = log10(control + 1),
    log10_treatment = log10(treatment + 1),
    log10fc = log10_treatment - log10_control,
    log2fc = log2((treatment + 1) / (control + 1)),
    pct_remaining = (treatment / control) * 100
  )

write_tsv(react_summary, here("data", "reactivity_processed.tsv"))

# --- hit counts for hexbin annotations ---
hit_counts <- react_summary |>
  filter(!is.na(log2fc)) |>
  group_by(enzyme) |>
  summarise(
    total = n(),
    hits = sum(log2fc < -1),
    pct_hits = round(hits / total * 100, 1),
    .groups = "drop"
  )

# custom labeler: show 0 instead of 10^0 (pseudocount baseline)
label_log10_pseudocount <- function(x) {
  labs <- scales::label_math()(x)
  labs[x == 0] <- "0"
  labs
}

# --- Panel C: CYP2J2 log10fc histogram (fewer bins, with counts) ---
hist_c_data <- react_summary |> filter(enzyme == "CYP2J2")
hist_c_binned <- hist_c_data |>
  mutate(
    bin = cut(
      log10fc,
      breaks = seq(
        floor(min(log10fc, na.rm = TRUE) * 4) / 4,
        ceiling(max(log10fc, na.rm = TRUE) * 4) / 4,
        by = 0.25
      ),
      include.lowest = TRUE
    )
  ) |>
  count(bin) |>
  mutate(
    mid = (as.numeric(sub("\\(|\\[", "", sub(",.*", "", as.character(bin)))) +
      as.numeric(sub(".*,", "", sub("\\]|\\)", "", as.character(bin))))) /
      2
  )

panel_c <- hist_c_binned |>
  ggplot(aes(x = mid, y = n)) +
  geom_col(fill = "grey40", color = "black", linewidth = 0.2, width = 0.24) +
  geom_text(aes(label = n), vjust = -0.3, size = 1.8, color = "grey30") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    x = expression(atop(
      Delta ~ log[10] ~ "(peak area + 1)",
      "treatment - control"
    )),
    y = NULL,
    title = "CYP2J2"
  ) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

# --- Panel A: CYP3A4 log10fc histogram (fewer bins, with counts) ---
hist_a_data <- react_summary |> filter(enzyme == "CYP3A4")
hist_a_binned <- hist_a_data |>
  mutate(
    bin = cut(
      log10fc,
      breaks = seq(
        floor(min(log10fc, na.rm = TRUE) * 4) / 4,
        ceiling(max(log10fc, na.rm = TRUE) * 4) / 4,
        by = 0.25
      ),
      include.lowest = TRUE
    )
  ) |>
  count(bin) |>
  mutate(
    mid = (as.numeric(sub("\\(|\\[", "", sub(",.*", "", as.character(bin)))) +
      as.numeric(sub(".*,", "", sub("\\]|\\)", "", as.character(bin))))) /
      2
  )

panel_a <- hist_a_binned |>
  ggplot(aes(x = mid, y = n)) +
  geom_col(fill = "grey40", color = "black", linewidth = 0.2, width = 0.24) +
  geom_text(aes(label = n), vjust = -0.3, size = 1.8, color = "grey30") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    x = expression(atop(
      Delta ~ log[10] ~ "(peak area + 1)",
      "treatment - control"
    )),
    y = "count",
    title = "CYP3A4"
  ) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

# --- shared hex plot theme overrides ---
hex_theme <- theme(
  panel.grid.major.y = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(),
  legend.key.height = unit(1, "null"),
  legend.title.position = "left",
  legend.title = element_text(angle = 90),
  legend.key.width = unit(0.5, "lines"),
  legend.frame = element_rect(color = "black", linewidth = 0.5),
  legend.text = element_text(margin = margin(l = 4)),
  axis.text.x = element_text(angle = 0, hjust = 0.5)
)

# --- Panel D: CYP2J2 hexbin ---
panel_d <- react_summary |>
  filter(enzyme == "CYP2J2") |>
  ggplot(aes(x = log10_control, y = log10_treatment)) +
  geom_hex(color = "black", linewidth = 0.3, bins = 30) +
  annotate(
    "segment",
    x = 3.6,
    xend = 6,
    y = 3.5,
    yend = 6,
    color = "red",
    linetype = "dashed"
  ) +
  geom_text(
    data = hit_counts |> filter(enzyme == "CYP2J2"),
    aes(
      x = 0,
      y = 5.75,
      label = paste0("hit rate: ", hits, " / ", total, " (", pct_hits, "%)")
    ),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 3,
    hjust = 0
  ) +
  scico::scale_fill_scico(
    palette = "managua",
    trans = "log10",
    breaks = c(1, 3, 10, 30, 50),
    limits = c(1, 60)
  ) +
  scale_x_continuous(
    labels = \(x) as.integer(x),
    breaks = 0:6,
    limits = c(3, NA)
  ) +
  scale_y_continuous(
    labels = \(x) as.integer(x),
    breaks = 0:6,
    limits = c(NA, 6)
  ) +
  labs(
    x = expression(Control ~ log[10](peak ~ area + 1)),
    y = expression(Treatment ~ log[10](peak ~ area + 1)),
    fill = "# cpds"
  ) +
  hex_theme +
  theme(legend.position = "none")

# --- Panel B: CYP3A4 hexbin ---
panel_b <- react_summary |>
  filter(enzyme == "CYP3A4") |>
  ggplot(aes(x = log10_control, y = log10_treatment)) +
  geom_hex(color = "black", linewidth = 0.3, bins = 30) +
  annotate(
    "segment",
    x = 3.6,
    xend = 6,
    y = 3.5,
    yend = 6,
    color = "red",
    linetype = "dashed"
  ) +
  geom_text(
    data = hit_counts |> filter(enzyme == "CYP3A4"),
    aes(
      x = 0,
      y = 5.75,
      label = paste0("hit rate: ", hits, " / ", total, " (", pct_hits, "%)")
    ),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 3,
    hjust = 0
  ) +
  scico::scale_fill_scico(
    palette = "managua",
    trans = "log10",
    breaks = c(1, 3, 10, 30, 50),
    limits = c(1, 60)
  ) +
  scale_x_continuous(
    labels = \(x) as.integer(x),
    breaks = 0:6,
    limits = c(3, NA)
  ) +
  scale_y_continuous(
    labels = \(x) as.integer(x),
    breaks = 0:6,
    limits = c(NA, 6)
  ) +
  labs(
    x = expression(Control ~ log[10](peak ~ area + 1)),
    y = expression(Treatment ~ log[10](peak ~ area + 1)),
    fill = "n"
  ) +
  hex_theme +
  theme(
    legend.position = c(0.02, 0.5),
    legend.justification = c(0, 0.5),
    legend.title = element_blank(),
    legend.background = element_blank()
  )

# --- IC50 bin categories (shared by panels E and F) ---
ic50_levels <- c(
  "inactive",
  "10\u2013100 \u00b5M",
  "1\u201310 \u00b5M",
  "100 nM\u20131 \u00b5M",
  "<100 nM"
)
pal30 <- paletteer::paletteer_c("ggthemes::Sunset-Sunrise Diverging", 30)
ic50_colors <- setNames(
  pal30[c(1, 8, 15, 22, 30)],
  ic50_levels
)

inhib_binned <- inhibition_df |>
  mutate(
    pIC50_plot = case_when(
      # group inactive molecules together for histogram
      is.na(CYP3A4_pIC50) ~ 2.875,
      CYP3A4_pIC50 < 4 ~ 2.875,
      .default = CYP3A4_pIC50
    ),
    ic50_bin = factor(
      coalesce(
        as.character(cut(
          CYP3A4_pIC50,
          breaks = c(-Inf, 4, 5, 6, 7, Inf),
          labels = ic50_levels,
          right = FALSE
        )),
        "inactive"
      ),
      levels = ic50_levels
    )
  )

# shared x-axis for panels E and F
pIC50_x_scale <- scale_x_reverse(
  breaks = c(8, 7, 6, 5, 4, 2.875),
  labels = c("8", "7", "6", "5", "4", "inactive"),
  limits = c(8, 2.5)
)

# --- Panel E: pIC50 distribution histogram ---
panel_e <- inhib_binned |>
  ggplot(aes(x = pIC50_plot, fill = ic50_bin)) +
  geom_histogram(
    binwidth = 0.25,
    color = "black",
    linewidth = 0.2,
    boundary = 4
  ) +
  stat_bin(
    aes(x = pIC50_plot, label = after_stat(ifelse(count == 0, "", count))),
    geom = "text",
    binwidth = 0.25,
    boundary = 4,
    vjust = -0.3,
    size = 1.8,
    color = "grey30",
    inherit.aes = FALSE
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  pIC50_x_scale +
  scale_fill_manual(expression("IC"[50] ~ "range"), values = ic50_colors) +
  labs(
    x = expression("CYP3A4 pIC"[50]),
    y = "",
    title = expression("CYP3A4 Inhibition pIC"[50])
  ) +
  theme(
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.background = element_blank(),
    legend.text = element_text(size = rel(0.7)),
    legend.key.size = unit(0.4, "lines"),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) +
  guides(fill = guide_legend(ncol = 1))

# --- Panel F: inhibition vs reactivity scatter ---
react_3a4 <- react_summary |>
  filter(enzyme == "CYP3A4") |>
  select(ocnt_batch, log2fc)

inhib_react <- inhib_binned |>
  inner_join(react_3a4, by = "ocnt_batch")

active_data <- inhib_react |> filter(CYP3A4_pIC50 >= 4)
inactive_data <- inhib_react |> filter(is.na(CYP3A4_pIC50) | CYP3A4_pIC50 < 4)

panel_f <- ggplot() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey50") +
  geom_point(
    data = active_data,
    aes(x = pIC50_plot, y = log2fc, color = ic50_bin),
    alpha = 0.5,
    size = 1.5,
    shape = 16
  ) +
  geom_beeswarm(
    data = inactive_data,
    aes(x = pIC50_plot, y = log2fc, color = ic50_bin),
    alpha = 0.5,
    size = 1.5,
    shape = 16,
    cex = 2,
    corral = "wrap",
    corral.width = 0.8
  ) +
  pIC50_x_scale +
  scale_color_manual(expression("IC"[50] ~ "range"), values = ic50_colors) +
  labs(
    x = expression("CYP3A4 pIC"[50]),
    y = expression(log[2] ~ "(treatment / control)"),
    title = "Inhibition vs Reactivity"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

# --- assemble figure ---
wrap_plots(
  panel_a,
  panel_c,
  panel_e,
  panel_b,
  panel_d,
  panel_f,
  ncol = 3
) +
  plot_annotation(tag_levels = list(c("A", "C", "E", "B", "D", "F"))) &
  theme(plot.tag = element_text(size = 16, face = "bold"))
```
