```{r}
#| label: banner-drc-animation
#| cache: true
#| echo: false
#| message: false
#| warning: false

library(gganimate)

# --- load inhibition data and filter active compounds ---

inh <- read_tsv(here("data", "inhibition.tsv"))
active <- inh |>
  filter(activity_status == "YES", !is.na(CYP3A4_pIC50))

# --- generate dose-response curves ---

log_conc_seq <- seq(-9, -3.5, length.out = 300)

curves <- active |>
  mutate(wave = ntile(CYP3A4_pIC50, 30)) |>
  crossing(log_conc = log_conc_seq) |>
  mutate(
    slope = 2^slope_log2,
    emax_fc = 2^emax_log2fc,
    activity = 1 + (emax_fc - 1) / (1 + 10^(slope * (-CYP3A4_pIC50 - log_conc)))
  ) |>
  select(compound = ocnt_batch, log_conc, activity, pIC50 = CYP3A4_pIC50, wave)

p <- ggplot(
  curves,
  aes(x = log_conc, y = activity, group = compound, colour = pIC50)
) +
  geom_line(alpha = 0.25, linewidth = 0.5) +
  scale_x_continuous(
    name = bquote(Log[10] ~ concentration ~ "(M)"),
    breaks = seq(-11, -4, by = 1),
    labels = seq(-11, -4, by = 1)
  ) +
  scale_y_continuous(
    name = "CYP3A4 activity",
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 1)
  ) +
  scale_colour_viridis_c(option = "mako", guide = "none") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(linewidth = 0.5),
    axis.ticks = element_blank(),
    axis.title = element_text(size = rel(1)),
    axis.text.x = element_text(size = rel(1), margin = margin(t = 4)),
    axis.text.y = element_text(size = rel(1), margin = margin(r = 4)),
  ) +
  transition_states(
    wave,
    transition_length = 3,
    state_length = 0,
    wrap = TRUE
  ) +
  ease_aes("cubic-out") +
  shadow_mark(alpha = 0.15, linewidth = 0.2)

anim <- animate(
  p,
  nframes = 90,
  fps = 30,
  width = 800,
  height = 500,
  units = "px",
  res = 150,
  renderer = gifski_renderer()
)

gif_path_abs <- here::here("post/figures/banner_drc_animation.gif")
anim_save(gif_path_abs, anim)

# Display the GIF
knitr::include_graphics("post/figures/banner_drc_animation.gif")
```
