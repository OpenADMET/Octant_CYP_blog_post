project:
  output-dir: _site
  render:
    - cyp-blog-post.qmd
format:
  html:
    # self-contained: true  # re-enable for final publish
    toc: true
    toc-location: left
    smooth-scroll: true
    number-sections: false
    lightbox: true
    mainfont: "Inter, sans-serif"
    include-in-header:
      - text: |
          <link rel="preconnect" href="https://rsms.me/">
          <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
          <style>
            :root { font-feature-settings: 'liga' 1, 'calt' 1; }
            @supports (font-variation-settings: normal) {
              :root { font-family: InterVariable, sans-serif; }
            }
            .figure-caption {
              font-size: 0.85em;
              color: #555;
              line-height: 1.45;
              margin-top: 0.5em;
              margin-bottom: 1.5em;
            }
            /* Center static images; keep widgets full-width */
            .cell-output-display > p,
            .cell-output-display > img {
              display: block;
              margin-left: auto;
              margin-right: auto;
              margin-bottom: 0;
              text-align: center;
            }
            /* Spacing: paragraphs, headings, figures, lists */
            main { line-height: 1.75; }
            main p { margin-bottom: 1.6em; }
            main h2 { margin-top: 2.5em; margin-bottom: 1em; }
            main h3 { margin-top: 2em; margin-bottom: 0.8em; }
            main ul, main ol { margin-top: 1em; margin-bottom: 1.6em; }
            main li { margin-bottom: 0.4em; }
            .cell { margin-top: 2em; margin-bottom: 2em; }
            .figure-caption { padding-bottom: 3em; }
            .cell + .figure-caption { margin-top: 0.5em; }
            .doc-version {
              font-size: 0.78em;
              color: #888;
              border-top: 1px solid #e0e0e0;
              padding-top: 0.8em;
              margin-top: 3em;
            }
            /* Fix ggiraph fullscreen: height:90vw is a bug (should be width) */
            .ggiraph-fullscreen-content { height: auto; width: 90vw; }
            .ggiraph-fullscreen-content:has(.ggiraph-fullscreen-caption) {
              flex-direction: column;
            }
            .ggiraph-fullscreen-caption {
              font-size: 0.8em;
              color: #000;
              line-height: 1.4;
              padding: 8px 20px 0;
              text-align: left;
              max-height: 15vh;
              overflow-y: auto;
              margin-top: auto;
            }
            /* Instant CSS tooltips for citation links */
            .cite-tip { position: relative; }
            .cite-tip:hover::after {
              content: attr(data-tooltip);
              position: absolute;
              bottom: calc(100% + 4px);
              left: 50%;
              transform: translateX(-50%);
              background: white;
              border: 1px solid #ccc;
              border-radius: 6px;
              padding: 6px 10px;
              font-size: 0.8em;
              line-height: 1.4;
              white-space: normal;
              width: max-content;
              max-width: 350px;
              box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
              z-index: 1000;
              pointer-events: none;
            }
          </style>
    include-after-body:
      - text: |
          <script>
            // Copy figure captions into lightbox descriptions
            document.querySelectorAll('.figure-caption').forEach(function(cap) {
              var prev = cap.previousElementSibling;
              if (!prev) return;
              var link = prev.querySelector('a.lightbox');
              if (!link) return;
              link.setAttribute('data-description', cap.innerHTML);
            });

            // Inject figure captions into ggiraph fullscreen modals.
            // Pre-build SVGâ†’caption map after widgets initialize (load event),
            // because openModal() moves the SVG out of .cell before the
            // MutationObserver callback fires.
            window.addEventListener('load', function() {
              var svgCaptions = {};
              document.querySelectorAll('.ggiraph-svg').forEach(function(svg) {
                var cell = svg.closest('.cell');
                if (!cell) return;
                var sib = cell.nextElementSibling;
                while (sib && !sib.classList.contains('figure-caption')) {
                  sib = sib.nextElementSibling;
                }
                if (sib) svgCaptions[svg.id] = sib;
              });
              new MutationObserver(function(mutations) {
                mutations.forEach(function(m) {
                  m.addedNodes.forEach(function(node) {
                    if (node.nodeType !== 1) return;
                    if (!node.classList.contains('ggiraph-fullscreen-modal')) return;
                    var svgId = node.id.replace('_fullscreen_modal', '');
                    var caption = svgCaptions[svgId];
                    if (!caption) return;
                    var content = node.querySelector('.ggiraph-fullscreen-content');
                    if (!content) return;
                    var clone = caption.cloneNode(true);
                    clone.className = 'ggiraph-fullscreen-caption';
                    content.appendChild(clone);
                  });
                });
              }).observe(document.body, { childList: true });
            });
          </script>
execute:
  warning: false
knitr:
  opts_chunk:
    fig.align: "center"
    warning: false
    message: true
    collapse: true
    echo: false
    dev: ragg_png
    dpi: 300
