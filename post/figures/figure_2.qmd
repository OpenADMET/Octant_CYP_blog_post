```{python}
#| label: figure-2-data
#| cache: false


from bokeh.layouts import gridplot
from scipy.stats import gaussian_kde

# --- load data (pre-filtered by scripts/prepare_data.py) ---

peak_areas = pd.read_csv(repo_root / "data/reactivity.tsv", sep="\t")

cpds = peak_areas[["ocnt_batch", "standardized_smiles"]].drop_duplicates(subset="ocnt_batch")

# --- summarize replicates ---

summary = (
    peak_areas
    .groupby(["ocnt_batch", "enzyme", "condition"])["area"]
    .mean()
    .reset_index()
    .pivot_table(index=["ocnt_batch", "enzyme"], columns="condition", values="area")
    .reset_index()
)

summary["pct_remaining"] = (summary["treatment"] / summary["control"]) * 100

# --- pivot for each metric ---

def pivot_metric(metric):
    return (
        summary[["ocnt_batch", "enzyme", metric]]
        .pivot_table(index="ocnt_batch", columns="enzyme", values=metric)
        .reset_index()
        .dropna()
    )

react_pct = pivot_metric("pct_remaining")

# join SMILES
react_pct = react_pct.merge(cpds, on="ocnt_batch", how="left").dropna(subset=["standardized_smiles"])

# --- render molecule images ---

react_pct["mol_img"] = react_pct["standardized_smiles"].apply(smiles_to_svg)

# --- swarmplot images for tooltips ---

_swarm_cache = {}
for batch in set(react_pct["ocnt_batch"]):
    _swarm_cache[batch] = save_tooltip_svg(make_swarm_svg(batch, peak_areas), name=f"swarm_{batch}")

react_pct["swarm_img"] = react_pct["ocnt_batch"].map(_swarm_cache)

# --- helper: scatter + marginal densities ---

TOOLTIPS = """
<div style="width:340px;">
    <div style="text-align:center;"><b>@batch</b></div>
    <div style="text-align:center;"><img src="@mol_img{safe}" width="200"></div>
    <div style="margin-top:4px;"><img src="@swarm_img{safe}" height="130"></div>
</div>
"""

def marginal_scatter(df, xcol, ycol, xlabel, ylabel):
    x = df[xcol].values
    y = df[ycol].values

    source = ColumnDataSource(data={
        "x": x, "y": y,
        "mol_img": df["mol_img"],
        "swarm_img": df["swarm_img"],
        "batch": df["ocnt_batch"],
    })

    lo = min(x.min(), y.min()) - abs(min(x.min(), y.min())) * 0.05 - 1
    hi = max(x.max(), y.max()) + abs(max(x.max(), y.max())) * 0.05 + 1

    # main scatter
    p = bokeh_figure(
        width=500, height=500,
        x_axis_label=xlabel, y_axis_label=ylabel,
        tools="pan,wheel_zoom,box_zoom,reset,save",
        x_range=(lo, hi), y_range=(lo, hi),
    )
    p.xaxis.axis_label_text_font_style = "normal"
    p.yaxis.axis_label_text_font_style = "normal"
    p.scatter("x", "y", source=source, size=6,
              fill_alpha=0.35, line_color="white", line_width=0.5)
    p.add_tools(HoverTool(tooltips=TOOLTIPS))

    # marginal top
    x_kde = gaussian_kde(x)
    x_grid = np.linspace(lo, hi, 300)
    x_dens = x_kde(x_grid)

    ph = bokeh_figure(
        width=p.width, height=120, x_range=p.x_range,
        tools="", toolbar_location=None,
    )
    ph.line(x_grid, x_dens, line_color="steelblue", line_width=1.5)
    ph.varea(x=x_grid, y1=0, y2=x_dens, fill_color="steelblue", fill_alpha=0.15)
    ph.xaxis.visible = False
    ph.yaxis.visible = False
    ph.outline_line_color = None
    ph.grid.visible = False
    ph.min_border_bottom = 0
    ph.min_border_left = p.min_border_left

    # marginal right
    y_kde = gaussian_kde(y)
    y_grid = np.linspace(lo, hi, 300)
    y_dens = y_kde(y_grid)

    pv = bokeh_figure(
        width=120, height=p.height, y_range=p.y_range,
        tools="", toolbar_location=None,
    )
    pv.line(y_dens, y_grid, line_color="steelblue", line_width=1.5)
    pv.harea(y=y_grid, x1=0, x2=y_dens, fill_color="steelblue", fill_alpha=0.15)
    pv.xaxis.visible = False
    pv.yaxis.visible = False
    pv.outline_line_color = None
    pv.grid.visible = False
    pv.min_border_bottom = p.min_border_bottom
    pv.min_border_left = 0

    layout = gridplot([[ph, None], [p, pv]], merge_tools=False)
    script, div = components(layout)
    return HTML(CDN.render() + div + script)
```

```{python}
#| label: figure-2-plot
#| cache: false


marginal_scatter(
    react_pct, "CYP3A4", "CYP2J2",
    xlabel="CYP3A4 (% remaining)",
    ylabel="CYP2J2 (% remaining)",
)
```
