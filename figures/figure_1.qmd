```{python}
#| label: figure-1
#| echo: false

# --- load data ---

peak_areas = pd.read_csv(
    repo_root / "data/20260209_CBR-1304-cpds_vs_CYP3A4,2J2_primary_ind-reps_filtered.csv"
)

cpds = pd.read_csv(
    repo_root / "data/2025-09-10_selected-cpds.tsv",
    sep="\t",
    usecols=["ocnt_batch", "cxsmiles"]
).drop_duplicates(subset="ocnt_batch")

# --- summarize replicates and compute log2 fold change ---

summary = (
    peak_areas
    .groupby(["ocnt_batch", "enzyme", "condition"])["area"]
    .mean()
    .reset_index()
    .pivot_table(index=["ocnt_batch", "enzyme"], columns="condition", values="area")
    .reset_index()
)

# log2 fold change (treatment / control), with pseudocount to avoid log(0)
summary["log2fc"] = np.log2((summary["treatment"] + 1) / (summary["control"] + 1))

# pivot to get one row per compound with CYP3A4 and CYP2J2 side by side
reactivity = (
    summary[["ocnt_batch", "enzyme", "log2fc"]]
    .pivot_table(index="ocnt_batch", columns="enzyme", values="log2fc")
    .reset_index()
    .dropna()
)

# join SMILES
reactivity = reactivity.merge(cpds, on="ocnt_batch", how="left").dropna(subset=["cxsmiles"])

# --- render molecule SVGs ---

def smiles_to_svg(smiles, size=(200, 200)):
    mol = Chem.MolFromSmiles(smiles)
    if mol is None:
        return ""
    d2d = Draw.MolDraw2DSVG(*size)
    d2d.DrawMolecule(mol)
    d2d.FinishDrawing()
    return d2d.GetDrawingText().replace("\n", "")

reactivity["svg"] = reactivity["cxsmiles"].apply(smiles_to_svg)

# --- bokeh scatter plot ---

source = ColumnDataSource(data={
    "x": reactivity["CYP3A4"],
    "y": reactivity["CYP2J2"],
    "svg": reactivity["svg"],
})

TOOLTIPS = """
<div style="width:220px;">
    <div>@svg{safe}</div>
</div>
"""

p = bokeh_figure(
    width=600,
    height=600,
    title="CYP3A4 vs CYP2J2 Reactivity",
    x_axis_label="CYP3A4 log₂(treatment / control)",
    y_axis_label="CYP2J2 log₂(treatment / control)",
    tools="pan,wheel_zoom,box_zoom,reset,save",
)

p.scatter(
    "x", "y",
    source=source,
    size=6,
    fill_alpha=0.5,
    line_color="white",
    line_width=0.5,
)

# reference lines at 0
p.line([-10, 5], [0, 0], line_dash="dashed", line_color="grey", line_alpha=0.5)
p.line([0, 0], [-10, 5], line_dash="dashed", line_color="grey", line_alpha=0.5)

p.add_tools(HoverTool(tooltips=TOOLTIPS))

script, div = components(p)
HTML(CDN.render() + div + script)
```
